<!DOCTYPE html><html lang=zh-CN translate=no><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><title>FloeLM</title><link rel=icon type=image/svg+xml href=./resources/icon/favicon.svg><link rel=icon type=image/png sizes=32x32 href=./resources/icon/favicon.png><meta name=google content=notranslate><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel=stylesheet><link rel=stylesheet href=./resources/material-symbols-rounded.css><link rel=stylesheet href=./resources/atom-one-dark.min.css><style>:root{--text-color:#EAEAEA;--subheading-color:#8E8E93;--placeholder-color:#8A8A8A;--primary-color:#121212;--secondary-color:rgba(28, 28, 30, .7);--secondary-solid-color:#1C1C1E;--secondary-hover-color:#2C2C2E;--border-color:#38383A;--accent-color:#EAEAEA;--accent-color-hover:#CCCCCC;--error-color:#e55865;--error-color-hover:#c04a57;--success-color:#28a745;--info-color:#17a2b8;--border-radius-main:5px;--sidebar-width:260px;--backdrop-blur:10px;--settings-panel-bg:rgba(28, 28, 30, .6);--settings-nav-bg:rgba(18, 18, 18, .6);--toggle-bg-off:#39393D;--toggle-bg-on:#FFFFFF;--toggle-circle:#1C1C1E;--toggle-circle-off:#848488;--spacing-xs:.25rem;--spacing-sm:.5rem;--spacing-md:1rem;--spacing-lg:1.5rem;--spacing-xl:2rem;--base-font-size:1rem;--chat-font-size:var(--base-font-size);--heading-font-size-h1:calc(var(--base-font-size) * 2);--heading-font-size-h2:calc(var(--base-font-size) * 1.75);--heading-font-size-h3:calc(var(--base-font-size) * 1.5);--heading-font-size-h4:calc(var(--base-font-size) * 1.25);--heading-font-size-h5:calc(var(--base-font-size) * 1.1);--heading-font-size-h6:var(--base-font-size);--panel-bg:#1C1C1E;--panel-border:#38383A;--text-primary:#FFFFFF;--text-secondary:#8E8E93;--outgoing-message-bg:#343541;--range-track-bg:#4A4A4F;--range-thumb-border:#8E8E93;--range-thumb-bg:#1C1C1E}.light-mode{--text-color:#222;--subheading-color:#666;--placeholder-color:#888;--primary-color:#F7F7F7;--secondary-color:rgba(255, 255, 255, .7);--secondary-solid-color:#FFF;--secondary-hover-color:#F0F0F0;--border-color:#E0E0E0;--settings-panel-bg:rgba(255, 255, 255, .6);--settings-nav-bg:rgba(247, 247, 247, .6);--toggle-bg-off:#E5E5EA;--toggle-bg-on:#000000;--toggle-circle:#FFFFFF;--toggle-circle-off:#FFFFFF;--panel-bg:#FFFFFF;--panel-border:#EAEAEA;--text-primary:#222222;--text-secondary:#666666;--accent-color:#1D1D1F;--accent-color-hover:#3c3c3e;--outgoing-message-bg:#E1EFFF;--range-track-bg:#C7C7CC;--range-thumb-border:#8E8E93;--range-thumb-bg:#FFFFFF}body.font-size-small{--base-font-size:.9rem}body.font-size-large{--base-font-size:1.1rem}*{margin:0;padding:0;box-sizing:border-box;font-family:Inter,sans-serif;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}body,html{height:100%;width:100%;overflow:hidden;background-image:url(https://source.unsplash.com/random/1920x1080?abstract,dark);background-size:cover;background-position:center}body{color:var(--text-color);transition:background .3s ease,color .3s ease;display:flex;backdrop-filter:saturate(180%) blur(20px);background-color:rgba(0,0,0,.3);font-size:var(--base-font-size)}*,body{user-select:none;-webkit-user-select:none;-ms-user-select:none;-moz-user-select:none;-webkit-user-drag:none}.text,[contenteditable=true],code,input,textarea{user-select:text;-webkit-user-select:text;-ms-user-select:text;-moz-user-select:text}::-webkit-scrollbar{display:none}body.settings-open>.app-wrapper{filter:blur(4px);pointer-events:none}body.animations-disabled *,body.animations-disabled ::after,body.animations-disabled ::before{transition:none!important;animation:none!important}textarea{resize:none}.glass-button{background:var(--secondary-color);backdrop-filter:blur(var(--backdrop-blur));border:1px solid var(--border-color);border-radius:var(--border-radius-main);color:var(--text-color);cursor:pointer;transition:all .2s ease;display:flex;align-items:center;justify-content:center;font-size:var(--base-font-size);font-weight:500;padding:.75rem 1.25rem;gap:.5rem}.glass-button:hover{background:var(--secondary-hover-color);box-shadow:0 4px 10px rgba(0,0,0,.1)}.accent-button{background:var(--accent-color);border:none;color:var(--primary-color);box-shadow:0 4px 10px rgba(0,0,0,.2)}.accent-button:hover{background:var(--accent-color-hover);box-shadow:0 6px 15px rgba(0,0,0,.2)}.light-mode .accent-button{color:var(--secondary-solid-color)}.error-button{background-color:var(--error-color);border:none;color:#fff;box-shadow:0 4px 10px rgba(229,88,101,.2)}.error-button:hover{background-color:var(--error-color-hover);box-shadow:0 6px 15px rgba(229,88,101,.3)}.glass-input{padding:.75rem;border-radius:var(--border-radius-main);border:1px solid var(--border-color);background:var(--primary-color);color:var(--text-color);font-size:var(--base-font-size);outline:0;transition:all .2s ease;width:100%}.glass-input:focus{border-color:var(--accent-color);box-shadow:0 0 0 3px rgba(174,174,178,.2)}.app-wrapper{display:flex;width:100%;height:100%;transition:filter .3s ease;background:var(--primary-color)}.sidebar{width:var(--sidebar-width);background:var(--secondary-color);backdrop-filter:blur(var(--backdrop-blur));display:flex;flex-direction:column;padding:var(--spacing-md);border-right:none;transition:margin-left .3s ease,background .3s ease,border-color .3s ease;flex-shrink:0;z-index:100}body.sidebar-closed .sidebar{margin-left:calc(-1 * var(--sidebar-width))}.main-content{flex-grow:1;display:flex;flex-direction:column;height:100%;position:relative}.chat-view{flex-grow:1;display:flex;flex-direction:column;width:100%;max-width:900px;margin:0 auto;padding:0 var(--spacing-md);position:relative;overflow:hidden}.sidebar-header{display:flex;justify-content:space-between;align-items:center;padding-bottom:var(--spacing-md);margin-bottom:var(--spacing-md)}.sidebar-header h3{font-size:calc(var(--base-font-size) * 1.25);font-weight:600}#session-search{width:100%;margin-bottom:var(--spacing-md)}.chat-session-list{list-style:none;flex-grow:1;overflow-y:auto}.chat-session-list li{padding:.75rem var(--spacing-md);margin-bottom:var(--spacing-sm);border-radius:var(--border-radius-main);cursor:pointer;transition:background .2s ease,border-color .2s ease;display:flex;align-items:center;justify-content:space-between;gap:var(--spacing-sm);background:0 0;font-size:calc(var(--base-font-size) * 1.05);border:1px solid var(--border-color)}.chat-session-list li:hover{background:var(--secondary-solid-color)}.chat-session-list li.active{background:var(--accent-color);color:var(--primary-color);border-color:transparent}.chat-session-list li.pinned-session{border-left:4px solid var(--accent-color)}.session-name{flex-grow:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.session-actions{display:flex;gap:var(--spacing-xs);opacity:0;transition:opacity .2s ease}.chat-session-list li.active .session-actions,.chat-session-list li:hover .session-actions{opacity:1}.session-actions .material-symbols-rounded{font-size:calc(var(--base-font-size) * 1.1);color:var(--subheading-color);padding:4px;border-radius:50%}.chat-session-list li.active .session-actions .material-symbols-rounded{color:var(--primary-color)}.session-actions .material-symbols-rounded:hover{background-color:rgba(255,255,255,.1)}.session-actions .material-symbols-rounded.pin-session.pinned{font-variation-settings:'FILL' 1;color:var(--accent-color)}.light-mode .chat-session-list li.active .session-actions .material-symbols-rounded{color:var(--secondary-solid-color)}.new-session-button{width:100%;margin-top:var(--spacing-md);border-radius:var(--border-radius-main);display:flex;align-items:center;justify-content:center;padding:.75rem 1.25rem;gap:.5rem}.header{text-align:center;margin:auto;padding:var(--spacing-xl) 0;transition:opacity .3s ease,visibility .3s ease;display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%}body.hide-header .header{opacity:0;visibility:hidden;display:none}.header .title{font-size:calc(var(--base-font-size) * 3.5);font-weight:700;line-height:1.2;margin-bottom:var(--spacing-sm);flex-shrink:0;color:var(--text-color)}.header .subtitle{font-size:calc(var(--base-font-size) * 1.5);color:var(--subheading-color);margin-top:var(--spacing-sm);flex-shrink:0}.suggestion-list{list-style:none;display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:var(--spacing-md);margin-top:3rem;text-align:left;width:100%;max-width:800px;overflow-y:auto;max-height:40vh;padding-right:var(--spacing-sm);padding-left:var(--spacing-sm)}.suggestion-list .suggestion{cursor:pointer;padding:1.25rem;border-radius:var(--border-radius-main);background:var(--secondary-solid-color);transition:background .2s ease,transform .2s ease;border:none;min-height:120px;display:flex;flex-direction:column;justify-content:space-between}.suggestion-list .suggestion:hover{background:var(--secondary-hover-color)}.suggestion-list .suggestion .icon{font-size:calc(var(--base-font-size) * 1.5);align-self:flex-end;color:var(--subheading-color)}.chat-list{position:absolute;top:0;left:0;right:0;bottom:0;overflow-y:auto;padding:var(--spacing-xl) 0}.chat-list .message{display:flex;gap:var(--spacing-md);margin-bottom:var(--spacing-xl);align-items:flex-start}.chat-list .message.outgoing{flex-direction:row-reverse}.chat-list .message .avatar{width:36px;height:36px;border-radius:50%;flex-shrink:0;background:var(--secondary-hover-color);align-items:center;justify-content:center;display:none}body.show-avatars .chat-list .message .avatar{display:flex}.chat-list .message .avatar .material-symbols-rounded{color:var(--subheading-color);font-size:calc(var(--base-font-size) * 1.4)}.chat-list .message .message-content{max-width:90%}.chat-list .message.outgoing .message-content .text{background-color:var(--outgoing-message-bg);padding:.75rem 1rem;border-radius:var(--border-radius-main)}.chat-list .message .text{line-height:1.7;word-wrap:break-word;font-size:var(--chat-font-size)}.chat-list .message .text .attached-image{max-width:100%;border-radius:var(--border-radius-main);margin-top:var(--spacing-sm)}.chat-list .message .text .attached-file-content{background-color:var(--panel-bg);border:1px solid var(--border-color);border-radius:var(--border-radius-main);padding:var(--spacing-sm) var(--spacing-md);margin-top:var(--spacing-sm);white-space:pre-wrap;font-family:monospace;max-height:200px;overflow-y:auto}.message-footer{margin-top:var(--spacing-sm);display:flex;flex-direction:column;gap:var(--spacing-sm)}.chat-list .message .action-btns{display:flex;align-items:center;gap:var(--spacing-xs);opacity:0;transition:opacity .2s ease;padding-left:.25rem}.chat-list .message:hover .action-btns{opacity:1}.chat-list .message .action-btns .icon{font-size:calc(var(--base-font-size) * 1.05);color:var(--subheading-color);cursor:pointer;padding:4px;border-radius:var(--border-radius-main);background:0 0;border:none}.chat-list .message .action-btns .icon:hover{background:var(--secondary-hover-color);color:var(--text-color)}.chat-list .message .action-btns .icon.thumb-up.active{color:var(--success-color)}.chat-list .message .action-btns .icon.thumb-down.active{color:var(--error-color)}.chat-list .message .action-btns .icon:disabled{cursor:default;opacity:.7}.chat-list .message .action-btns .icon:disabled:hover{background:0 0;color:var(--subheading-color)}.chat-list .message .action-btns .icon.active:disabled:hover{color:var(--success-color)}.chat-list .message .action-btns .icon.thumb-down.active:disabled:hover{color:var(--error-color)}.dialogue-info{font-size:calc(var(--base-font-size) * .8);color:var(--text-secondary);display:flex;align-items:center;gap:var(--spacing-md);flex-wrap:wrap}.dialogue-info span{display:inline-flex;align-items:center;gap:var(--spacing-xs)}.dialogue-info .separator{color:var(--border-color)}.thinking-process{border:1px solid var(--panel-border);border-radius:var(--border-radius-main);background:var(--panel-bg);overflow:hidden;margin-bottom:var(--spacing-sm)}.light-mode .thinking-process{background:rgba(0,0,0,.025)}.thinking-header{display:flex;align-items:center;gap:var(--spacing-sm);padding:var(--spacing-xs) var(--spacing-sm);cursor:pointer;background:0 0;color:var(--text-secondary);font-size:calc(var(--base-font-size) * .85);font-weight:500}.thinking-header .material-symbols-rounded{font-size:calc(var(--base-font-size) * 1.1);transition:transform .2s ease-in-out}.thinking-content-wrapper.collapsed .thinking-header .material-symbols-rounded{transform:rotate(-90deg)}.thinking-content{padding:var(--spacing-sm) var(--spacing-md);font-size:calc(var(--chat-font-size) * .9);line-height:1.6;max-height:300px;overflow-y:auto;border-top:1px solid var(--panel-border);transition:max-height .3s ease-out,padding .3s ease-out,opacity .3s ease-out}.thinking-content-wrapper.collapsed .thinking-content{max-height:0;padding-top:0;padding-bottom:0;opacity:0;border-top:1px solid transparent}.loading-indicator{display:flex;gap:.3rem;align-items:center}.loading-indicator .dot{width:8px;height:8px;border-radius:50%;background:var(--subheading-color);animation:bounce 1.4s infinite ease-in-out both}.loading-indicator .dot:nth-child(1){animation-delay:-.32s}.loading-indicator .dot:nth-child(2){animation-delay:-.16s}@keyframes bounce{0%,100%,80%{transform:scale(0)}40%{transform:scale(1)}}.typing-area-container{width:100%;max-width:900px;margin:0 auto;padding:var(--spacing-sm) 0 var(--spacing-lg) 0;flex-shrink:0;background:linear-gradient(to top,var(--primary-color),transparent);position:relative;z-index:10}#file-preview-container{display:flex;flex-wrap:wrap;gap:var(--spacing-sm);margin-bottom:var(--spacing-sm);padding:0 .75rem}.file-chip{display:inline-flex;align-items:center;gap:var(--spacing-sm);background:var(--secondary-solid-color);border:none;color:var(--text-color);padding:var(--spacing-xs) var(--spacing-sm);border-radius:var(--border-radius-main);font-size:.85rem}.file-chip .remove-file-btn{cursor:pointer;font-size:1rem;color:var(--subheading-color);background:0 0;border:none;padding:0;display:flex;align-items:center;justify-content:center}.file-chip .remove-file-btn:hover{color:var(--text-color)}.typing-form{position:relative;background:var(--panel-bg);border-radius:var(--border-radius-main);border:1px solid var(--border-color);padding:.75rem;display:flex;align-items:flex-end;gap:.75rem;transition:border-color .2s ease}.typing-form:focus-within{box-shadow:none;border-color:var(--accent-color)}.typing-input{width:100%;border:none;outline:0;font-size:var(--base-font-size);color:var(--text-color);padding:.25rem;background:0 0;line-height:1.5;max-height:200px;overflow-y:auto}.typing-input::placeholder{color:var(--placeholder-color)}.typing-form .icon-button{background:0 0;border:none;border-radius:var(--border-radius-main);color:var(--subheading-color);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:calc(var(--base-font-size) * 1.5);width:38px;height:38px;transition:all .2s ease;flex-shrink:0;padding:0}.typing-form .icon-button:hover{background:var(--secondary-hover-color);color:var(--text-color)}#send-message-button{background:var(--secondary-solid-color);color:var(--text-color);opacity:.5;cursor:not-allowed;transition:opacity .2s ease,background-color .2s ease,transform .2s ease;transform:scale(.9)}.typing-input:valid~#send-message-button,body.has-files .typing-form #send-message-button{background:var(--accent-color);color:var(--primary-color);opacity:1;cursor:pointer;transform:scale(1)}.light-mode .typing-input:valid~#send-message-button,.light-mode.has-files .typing-form #send-message-button{color:var(--secondary-solid-color)}.typing-input:valid~#send-message-button:hover,body.has-files .typing-form #send-message-button:hover{background:var(--accent-color-hover);transform:scale(1.05)}.disclaimer-text{display:none;text-align:center;font-size:calc(var(--base-font-size) * .75);margin-top:.75rem;color:var(--placeholder-color)}body.show-disclaimer .disclaimer-text{display:block}.top-level-button{position:fixed;top:var(--spacing-md);width:44px;height:44px;font-size:calc(var(--base-font-size) * 1.4);color:var(--text-color);background:var(--secondary-color);backdrop-filter:blur(var(--backdrop-blur));border-radius:var(--border-radius-main);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .3s ease;z-index:1001;border:none}.top-level-button:hover{background:var(--secondary-hover-color);transform:scale(1.05)}#sidebar-toggle-button{left:var(--spacing-md)}#settings-button{right:var(--spacing-md)}body.sidebar-open #sidebar-toggle-button{transform:translateX(var(--sidebar-width))}.drag-drop-overlay{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);backdrop-filter:blur(5px);z-index:100;display:none;align-items:center;justify-content:center;pointer-events:none;transition:opacity .2s ease;opacity:0}.main-content.drag-over .drag-drop-overlay{display:flex;opacity:1}.drag-drop-content{border:2px dashed var(--border-color);border-radius:var(--border-radius-main);padding:2rem 3rem;text-align:center;color:var(--text-color)}.drag-drop-content .material-symbols-rounded{font-size:4rem;margin-bottom:1rem}.settings-panel-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.3);backdrop-filter:blur(4px);z-index:1002;display:none;align-items:center;justify-content:center}.settings-panel{background:var(--settings-panel-bg);backdrop-filter:blur(var(--backdrop-blur));z-index:1003;box-shadow:0 10px 30px rgba(0,0,0,.2);border:1px solid var(--border-color);display:flex;overflow:hidden;width:100%;height:100%;border-radius:0}.settings-panel-overlay.windowed-view .settings-panel{max-width:850px;width:90%;height:70vh;max-height:600px;border-radius:var(--border-radius-main)}.settings-nav{width:240px;background:var(--settings-nav-bg);backdrop-filter:blur(var(--backdrop-blur));padding:var(--spacing-md) 0;display:flex;flex-direction:column;border-right:1px solid var(--border-color);flex-shrink:0}.settings-nav-item{display:flex;align-items:center;padding:.8rem 1.5rem;gap:var(--spacing-md);cursor:pointer;color:var(--text-color);font-size:calc(var(--base-font-size) * .95);font-weight:500;border-left:3px solid transparent}.settings-nav-item:hover{background:var(--secondary-hover-color)}.settings-nav-item.active{background:var(--secondary-solid-color);color:var(--accent-color);border-left-color:var(--accent-color)}.settings-nav-item .material-symbols-rounded{font-size:calc(var(--base-font-size) * 1.2);color:var(--subheading-color)}.settings-content-wrapper{flex-grow:1;position:relative;display:flex;flex-direction:column;overflow-y:auto}.settings-header{padding:1.2rem var(--spacing-xl);border-bottom:1px solid var(--border-color);display:flex;justify-content:space-between;align-items:center}.settings-header h3{font-size:calc(var(--base-font-size) * 1.15);font-weight:600}.close-settings-panel{cursor:pointer;color:var(--subheading-color);font-size:calc(var(--base-font-size) * 1.4)}.settings-form{padding:1.2rem var(--spacing-xl);flex-grow:1;font-size:calc(var(--base-font-size) * .9)}.settings-content{display:none;flex-direction:column;gap:1.2rem}.settings-content.active{display:flex}.form-group{display:flex;flex-direction:column;gap:var(--spacing-sm)}.form-group label{font-weight:500}.settings-content textarea{min-height:80px;font-size:calc(var(--base-font-size) * .9)}.theme-toggle-switch{display:flex;gap:5px;background:var(--primary-color);backdrop-filter:blur(var(--backdrop-blur));border-radius:var(--border-radius-main);padding:4px;border:1px solid var(--border-color)}.theme-toggle-switch button{flex:1;padding:6px 8px;border:none;border-radius:calc(var(--border-radius-main) - 2px);background:0 0;color:var(--text-color);font-size:calc(var(--base-font-size) * .85);cursor:pointer;transition:all .2s ease;display:flex;align-items:center;justify-content:center;gap:5px}.theme-toggle-switch button.active{background:var(--secondary-hover-color);color:var(--text-color)}.toggle-switch-container{display:flex;justify-content:space-between;align-items:center;padding:.6rem 0;border-bottom:1px solid var(--border-color)}.toggle-switch-container:last-of-type{border-bottom:none}.toggle-switch{position:relative;display:inline-block;width:44px;height:24px;flex-shrink:0}.toggle-switch input{opacity:0;width:0;height:0}.toggle-slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:var(--toggle-bg-off);transition:.3s;border-radius:12px}.toggle-slider:before{position:absolute;content:"";height:20px;width:20px;left:2px;bottom:2px;background-color:var(--toggle-circle-off);transition:.3s;border-radius:50%;box-shadow:0 1px 3px rgba(0,0,0,.2)}input:checked+.toggle-slider{background-color:var(--toggle-bg-on)}input:checked+.toggle-slider:before{transform:translateX(20px);background-color:var(--toggle-circle)}.settings-footer{padding:var(--spacing-md) var(--spacing-xl);border-top:1px solid var(--border-color);display:flex;justify-content:flex-end;margin-top:auto}.save-settings-btn{padding:.75rem 1.5rem;border-radius:var(--border-radius-main);border:none;background:var(--accent-color);color:var(--primary-color);cursor:pointer;font-size:var(--base-font-size);font-weight:500;transition:background .2s ease,transform .2s ease,box-shadow .2s ease}.light-mode .save-settings-btn{color:var(--secondary-solid-color)}.save-settings-btn:hover{background:var(--accent-color-hover);box-shadow:0 6px 15px rgba(0,0,0,.3)}.feedback-list{list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:var(--spacing-md)}.feedback-item{background:var(--secondary-solid-color);border-radius:var(--border-radius-main);padding:var(--spacing-md);border:1px solid var(--border-color)}.feedback-item-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:var(--spacing-sm)}.feedback-item-header .material-symbols-rounded{font-size:calc(var(--base-font-size) * 1.2)}.feedback-timestamp{font-size:calc(var(--base-font-size) * .8);color:var(--subheading-color)}.feedback-message-content{font-size:calc(var(--base-font-size) * .9);color:var(--text-color);line-height:1.6;max-height:6em;overflow:hidden;text-overflow:ellipsis;display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical}input[type=range]{-webkit-appearance:none;appearance:none;width:100%;height:20px;background:0 0;vertical-align:middle}input[type=range]::-webkit-slider-runnable-track{height:5px;background:var(--range-track-bg);border-radius:2.5px;position:relative;top:50%;transform:translateY(-50%)}input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:20px;height:20px;background:var(--range-thumb-bg);border:2px solid var(--range-thumb-border);border-radius:50%;cursor:pointer;position:relative;top:50%;transform:translateY(-50%)}input[type=range]::-moz-range-track{height:5px;background:var(--range-track-bg);border-radius:2.5px}input[type=range]::-moz-range-thumb{width:20px;height:20px;background:var(--range-thumb-bg);border:2px solid var(--range-thumb-border);border-radius:50%;cursor:pointer}input[type=range]::-ms-fill-lower,input[type=range]::-ms-fill-upper{height:5px;background:var(--range-track-bg);border-radius:2.5px}input[type=range]::-ms-thumb{width:20px;height:20px;background:var(--range-thumb-bg);border:2px solid var(--range-thumb-border);border-radius:50%;cursor:pointer}input[type=range]:focus{outline:0}.markdown-body{font-size:var(--chat-font-size);line-height:1.7}.markdown-body>:first-child{margin-top:0}.markdown-body>:last-child{margin-bottom:0}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{margin:1.5em 0 .5em;font-weight:600;line-height:1.3;color:var(--text-color)}.markdown-body h1{font-size:var(--heading-font-size-h1)}.markdown-body h2{font-size:var(--heading-font-size-h2)}.markdown-body h3{font-size:var(--heading-font-size-h3)}.markdown-body h4{font-size:var(--heading-font-size-h4)}.markdown-body h5{font-size:var(--heading-font-size-h5)}.markdown-body h6{font-size:var(--heading-font-size-h6)}.markdown-body p{margin:1em 0}.markdown-body a{color:var(--accent-color);text-decoration:none}.markdown-body a:hover{text-decoration:underline}.markdown-body code{font-family:SFMono-Regular,Consolas,"Liberation Mono",Menlo,Courier,monospace;background:var(--panel-bg);color:var(--text-color);border-radius:var(--border-radius-main);padding:.2em .4em;font-size:85%}.markdown-body pre{position:relative;background:var(--panel-bg);padding:var(--spacing-md);border-radius:var(--border-radius-main);overflow-x:auto;border:1px solid var(--border-color);width:100%;box-sizing:border-box}.markdown-body pre code{padding:0;font-size:100%;background:0 0;border:none}.markdown-body ol,.markdown-body ul{padding-left:2em;margin:1em 0}.markdown-body li{margin-bottom:.5em}.markdown-body blockquote{border-left:3px solid var(--border-color);margin:1em 0;padding:.2em 1em;color:var(--subheading-color)}.markdown-body table{width:100%;border-collapse:collapse;margin:1em 0}.markdown-body td,.markdown-body th{border:1px solid var(--border-color);padding:.8em;text-align:left}.markdown-body th{background-color:var(--secondary-solid-color);font-weight:600}.markdown-body strong{font-weight:700}.markdown-body em{font-style:italic}.copy-code-btn{position:absolute;top:8px;right:8px;background-color:var(--secondary-solid-color);border:1px solid var(--border-color);color:var(--text-color);padding:4px 8px;border-radius:var(--border-radius-main);cursor:pointer;opacity:0;transition:opacity .2s ease-in-out;font-size:.8rem;display:flex;align-items:center;gap:4px}.markdown-body pre:hover .copy-code-btn{opacity:1}.copy-code-btn .material-symbols-rounded{font-size:1rem}#custom-modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.6);backdrop-filter:blur(5px);display:flex;align-items:center;justify-content:center;z-index:2000;opacity:0;transition:opacity .3s ease;pointer-events:none}#custom-modal-overlay.show{opacity:1;pointer-events:auto}#custom-modal-overlay .modal-content{background:var(--secondary-solid-color);border-radius:var(--border-radius-main);padding:1.5rem;max-width:400px;width:90%;text-align:center;box-shadow:0 8px 20px rgba(0,0,0,.3);border:1px solid var(--border-color);transform:translateY(-20px);transition:transform .3s ease,opacity .3s ease;opacity:0}#custom-modal-overlay.show .modal-content{transform:translateY(0);opacity:1}#custom-modal-overlay h4{font-size:calc(var(--base-font-size) * 1.2);margin-bottom:.75rem;color:var(--text-color)}#custom-modal-overlay p{font-size:calc(var(--base-font-size) * .95);color:var(--subheading-color);margin-bottom:1.5rem}#custom-modal-overlay .modal-buttons{display:flex;justify-content:center;gap:var(--spacing-md)}#custom-modal-overlay .modal-buttons button{padding:.75rem 1.25rem;border-radius:var(--border-radius-main);font-size:var(--base-font-size);font-weight:500;transition:all .2s ease;cursor:pointer;border:none}#custom-modal-overlay .modal-confirm-btn{background:var(--accent-color);color:var(--primary-color);box-shadow:0 4px 10px rgba(0,0,0,.2)}.light-mode #custom-modal-overlay .modal-confirm-btn{color:var(--secondary-solid-color)}#custom-modal-overlay .modal-confirm-btn:hover{background:var(--accent-color-hover);box-shadow:0 6px 15px rgba(0,0,0,.3)}#custom-modal-overlay .modal-cancel-btn{background:var(--secondary-hover-color);color:var(--text-color)}#custom-modal-overlay .modal-cancel-btn:hover{background:var(--secondary-solid-color);box-shadow:0 4px 10px rgba(0,0,0,.1)}#toast-container{position:fixed;bottom:var(--spacing-xl);left:50%;transform:translateX(-50%);z-index:2001;display:flex;flex-direction:column;gap:var(--spacing-sm);pointer-events:none}.toast-message{background:rgba(0,0,0,.7);color:#fff;padding:.75rem 1.25rem;border-radius:var(--border-radius-main);box-shadow:0 4px 15px rgba(0,0,0,.2);opacity:0;transform:translateY(20px);transition:opacity .3s ease,transform .3s ease;display:flex;align-items:center;gap:var(--spacing-sm);pointer-events:auto;font-size:var(--base-font-size)}.toast-message.show{opacity:1;transform:translateY(0)}.toast-message.info{background:var(--info-color)}.toast-message.success{background:var(--success-color)}.toast-message.error{background:var(--error-color)}.toast-message .material-symbols-rounded{font-size:calc(var(--base-font-size) * 1.2)}@media (max-width:768px){body{display:block}.app-wrapper{display:block;overflow:hidden}.sidebar{position:fixed;height:100%;top:0;left:0;width:100%;transform:translateX(-100%);transition:transform .3s ease;border-right:none;box-shadow:4px 0 15px rgba(0,0,0,.1);z-index:1000}body.sidebar-open .sidebar{transform:translateX(0)}body.sidebar-closed .sidebar{transform:translateX(-100%);margin-left:0}#sidebar-toggle-button{transition:transform .3s ease,left .3s ease;z-index:1001}#settings-button{transition:transform .3s ease,right .3s ease;z-index:1001}body.sidebar-open #sidebar-toggle-button{left:calc(100% - 44px - var(--spacing-md));transform:translateX(0)}body.sidebar-open #settings-button{display:none}.main-content{width:100%;height:100%}.settings-panel{width:100%;height:100%;max-height:none;border-radius:0;flex-direction:column}.settings-panel-overlay.windowed-view .settings-panel{max-width:100%;width:100%;height:100%;max-height:none;border-radius:0}.settings-nav{width:100%;flex-direction:row;overflow-x:auto;border-right:none;border-bottom:1px solid var(--border-color);padding:var(--spacing-sm) 0}.settings-nav-item{flex-shrink:0;border-left:none;border-bottom:3px solid transparent;padding:.6rem 1rem}.settings-nav-item.active{border-bottom-color:var(--accent-color);border-left-color:transparent}.top-level-button{top:.5rem;width:40px;height:40px;font-size:calc(var(--base-font-size) * 1.2)}#sidebar-toggle-button{left:.5rem}#settings-button{right:.5rem}.chat-list{padding:var(--spacing-md) 0}.typing-area-container{padding:.5rem 0 1rem 0}.typing-form{margin:0 .5rem}.typing-input{padding:8px}.typing-form .icon-button{width:36px;height:36px;font-size:calc(var(--base-font-size) * 1.3)}.header .title{font-size:calc(var(--base-font-size) * 2.5)}.header .subtitle{font-size:calc(var(--base-font-size) * 1.2)}.suggestion-list{grid-template-columns:1fr}}</style></head><body class=sidebar-closed><div class=app-wrapper><aside class=sidebar><div class=sidebar-header><h3>Chats</h3></div><input type=text id=session-search placeholder=搜索对话... class=glass-input><ul class=chat-session-list></ul><button class="new-session-button accent-button"><span class=material-symbols-rounded>add</span> New Chat</button></aside><main class=main-content><div id=drag-drop-overlay class=drag-drop-overlay><div class=drag-drop-content><span class=material-symbols-rounded>upload_file</span><p>拖拽文件到这里以上传</p></div></div><div class=chat-view><header class=header><h1 class=title id=welcome-title>Hello, there</h1><p class=subtitle id=welcome-subtitle>How can I help you today?</p><ul class=suggestion-list id=welcome-suggestions></ul></header><div class=chat-list></div></div><div class=typing-area-container><div id=file-preview-container></div><form class=typing-form autocomplete=off><input type=file id=file-input hidden multiple=multiple><textarea placeholder="Send a message to the model..." class=typing-input required spellcheck=false></textarea><button type=submit id=send-message-button class=icon-button title="Send Message"><span class=material-symbols-rounded>arrow_upward</span></button> <button type=button id=stop-generation-btn class="icon-button error-button" title="Stop Generation" style=display:none><span class=material-symbols-rounded>stop_circle</span></button></form><p class=disclaimer-text id=disclaimer-text-element>FloeLM may display inaccurate info, so double-check its responses.</p></div></main></div><span id=sidebar-toggle-button class="top-level-button material-symbols-rounded">menu</span> <span id=settings-button class="top-level-button material-symbols-rounded">settings</span><div id=settings-panel-overlay class=settings-panel-overlay><div id=settings-panel class=settings-panel><nav class=settings-nav><div class="settings-nav-item active" data-section=appearance><span class=material-symbols-rounded>palette</span> <span>外观</span></div><div class=settings-nav-item data-section=behavior><span class=material-symbols-rounded>settings_ethernet</span> <span>行为偏好</span></div><div class=settings-nav-item data-section=customization><span class=material-symbols-rounded>tune</span> <span>自定义</span></div><div class=settings-nav-item data-section=data-management><span class=material-symbols-rounded>database</span> <span>数据管理</span></div><div class=settings-nav-item data-section=feedback><span class=material-symbols-rounded>feedback</span> <span>反馈</span></div><div class=settings-nav-item data-section=about><span class=material-symbols-rounded>info</span> <span>关于</span></div></nav><div class=settings-content-wrapper><header class=settings-header><h3 id=settings-title>外观</h3><span class="material-symbols-rounded close-settings-panel">close</span></header><form id=settings-form class=settings-form><div id=appearance-settings class="settings-content active"><div class=form-group><label>主题:</label><div class=theme-toggle-switch><button type=button data-theme=light-mode><span class=material-symbols-rounded>light_mode</span> 浅色</button> <button type=button data-theme=dark-mode><span class=material-symbols-rounded>dark_mode</span> 深色</button> <button type=button data-theme=system-mode><span class=material-symbols-rounded>desktop_windows</span> 系统</button></div></div><div class=toggle-switch-container><label for=settings-windowed-mode>窗口化设置</label><label class=toggle-switch><input type=checkbox id=settings-windowed-mode><span class=toggle-slider></span></label></div><div class=toggle-switch-container><label for=display-markdown>以 Markdown 格式显示的消息</label><label class=toggle-switch><input type=checkbox id=display-markdown checked=checked><span class=toggle-slider></span></label></div><div class=toggle-switch-container><label for=syntax-highlighting>代码语法高亮</label><label class=toggle-switch><input type=checkbox id=syntax-highlighting checked=checked><span class=toggle-slider></span></label></div><div class=toggle-switch-container><label for=show-dialogue-info>显示对话信息 (Token速度等)</label><label class=toggle-switch><input type=checkbox id=show-dialogue-info><span class=toggle-slider></span></label></div><div class=form-group><label for=font-size>字体大小:</label><select id=font-size class=glass-input><option value=small>小</option><option value=medium selected=selected>中</option><option value=large>大</option></select></div><div class=toggle-switch-container><label for=compact-mode>紧凑模式</label><label class=toggle-switch><input type=checkbox id=compact-mode><span class=toggle-slider></span></label></div><div class=toggle-switch-container><label for=show-timestamps>显示时间戳</label><label class=toggle-switch><input type=checkbox id=show-timestamps><span class=toggle-slider></span></label></div><div class=toggle-switch-container><label for=show-avatars>显示头像</label><label class=toggle-switch><input type=checkbox id=show-avatars><span class=toggle-slider></span></label></div><div class=toggle-switch-container><label for=enable-animations>启用UI动画</label><label class=toggle-switch><input type=checkbox id=enable-animations checked=checked><span class=toggle-slider></span></label></div></div><div id=behavior-settings class=settings-content><div class=toggle-switch-container><label for=enable-streaming>启用流式传输</label><label class=toggle-switch><input type=checkbox id=enable-streaming checked=checked><span class=toggle-slider></span></label></div><div class=toggle-switch-container><label for=auto-scroll>自动滚动到底部</label><label class=toggle-switch><input type=checkbox id=auto-scroll checked=checked><span class=toggle-slider></span></label></div><div class=toggle-switch-container><label for=show-thinking-process>显示深度思考过程</label><label class=toggle-switch><input type=checkbox id=show-thinking-process checked=checked><span class=toggle-slider></span></label></div><div class=toggle-switch-container><label for=auto-run-code>代码默认自动运行</label><label class=toggle-switch><input type=checkbox id=auto-run-code><span class=toggle-slider></span></label></div></div><div id=customization-settings class=settings-content><div class=form-group><label for=system-prompt>系统提示 (定义AI助手的行为):</label><textarea id=system-prompt class=glass-input></textarea></div><div class=form-group><label for=temperature>模型温度 (创造力): <span id=temperature-value>0.8</span></label><input type=range id=temperature min=0 max=1 step=0.1 value=0.8></div><div class=form-group><label for=welcome-title-input>欢迎标题:</label><input type=text id=welcome-title-input class=glass-input></div><div class=form-group><label for=welcome-subtitle-input>欢迎副标题:</label><input type=text id=welcome-subtitle-input class=glass-input></div><div class=form-group><label for=welcome-suggestions-input>欢迎建议 (每行一个，格式为 "文本|图标名称"):</label><textarea id=welcome-suggestions-input class=glass-input rows=5></textarea><small style=color:var(--subheading-color)>例如: Plan a game night for under $100|draw</small></div><div class=toggle-switch-container><label for=show-disclaimer>显示免责声明</label><label class=toggle-switch><input type=checkbox id=show-disclaimer><span class=toggle-slider></span></label></div><div class=form-group id=custom-disclaimer-group style=display:none><label for=custom-disclaimer-input>自定义免责声明文本:</label><textarea id=custom-disclaimer-input class=glass-input rows=3></textarea></div></div><div id=data-management-settings class=settings-content><div class=form-group><label for=api-key>API Key (Ollama可留空):</label><input type=password id=api-key placeholder="Enter your API key" class=glass-input></div><div class=form-group><label for=api-endpoint>API 端点:</label><input type=text id=api-endpoint placeholder=http://localhost:11434/api/chat class=glass-input></div><div class=form-group><label for=model>模型:</label><select id=model class=glass-input></select></div><div class=form-group style="border-top:1px solid var(--border-color);padding-top:var(--spacing-md);margin-top:var(--spacing-sm)"><label>模型管理:</label><div style=display:flex;gap:var(--spacing-md);flex-wrap:wrap><button type=button id=scan-ollama-models-btn class=glass-button>扫描本地模型</button> <button type=button id=add-custom-model-btn class=glass-button>添加自定义模型</button> <button type=button id=delete-selected-model-btn class="glass-button error-button" style=margin-left:auto>删除所选模型</button></div><small id=model-scan-status style=color:var(--subheading-color);min-height:1em></small></div><div class=form-group><label for=max-context-length>最大上下文长度 (消息数量):</label><input type=number id=max-context-length min=1 max=100 value=20 class=glass-input></div><div class=form-group style="border-top:1px solid var(--border-color);padding-top:var(--spacing-md);margin-top:var(--spacing-sm)"><label>对话数据</label><div style=display:flex;gap:var(--spacing-md)><button type=button id=import-all-chats-btn class=glass-button>导入对话</button><button type=button id=export-all-chats-btn class=glass-button>导出对话</button><button type=button id=clear-all-chats-btn class="glass-button error-button" style=margin-left:auto>清除所有对话</button></div></div><div class=form-group style="border-top:1px solid var(--border-color);padding-top:var(--spacing-md);margin-top:var(--spacing-sm)"><label>应用设置</label><div style=display:flex;gap:var(--spacing-md)><button type=button id=export-settings-btn class=glass-button>导出设置</button><button type=button id=import-settings-btn class=glass-button>导入设置</button></div></div></div><div id=feedback-settings class=settings-content></div><div id=about-settings class=settings-content><h3>关于 FloeLM</h3><p>版本: 3.2.0 (Enhanced)</p><p>一个现代化、功能丰富的开源聊天助手。</p><p>灵感来源于对高效与美学的追求。</p><a href=https://github.com/floeui target=_blank style=color:var(--accent-color)>查看源码</a></div></form><footer class=settings-footer><button type=button id=save-settings-btn class="save-settings-btn accent-button">保存设置</button></footer></div></div></div><div id=toast-container></div><div id=custom-modal-placeholder></div><script src=./resources/marked.min.js></script><script src=./resources/purify.min.js></script><script src=./resources/highlight.min.js></script><script>document.addEventListener("DOMContentLoaded", () => {
        // --- DOM Elements ---
        const body = document.body;
        const mainContent = document.querySelector('.main-content');
        const typingForm = document.querySelector(".typing-form");
        const typingInput = document.querySelector(".typing-input");
        const chatContainer = document.querySelector(".chat-list");
        const sidebarToggleBtn = document.querySelector("#sidebar-toggle-button");
        const settingsBtn = document.querySelector("#settings-button");
        const settingsOverlay = document.querySelector("#settings-panel-overlay");
        const closeSettingsBtn = document.querySelector(".close-settings-panel");
        const saveSettingsBtn = document.querySelector("#save-settings-btn");
        const sessionList = document.querySelector(".chat-session-list");
        const newSessionBtn = document.querySelector(".new-session-button");
        const stopGenerationBtn = document.querySelector("#stop-generation-btn");
        const sessionSearchInput = document.querySelector("#session-search");
        const settingsNavItems = document.querySelectorAll(".settings-nav-item");
        const settingsContents = document.querySelectorAll(".settings-content");
        const settingsTitle = document.querySelector("#settings-title");
        const welcomeTitleEl = document.getElementById("welcome-title");
        const welcomeSubtitleEl = document.getElementById("welcome-subtitle");
        const welcomeSuggestionsEl = document.getElementById("welcome-suggestions");
        const disclaimerEl = document.getElementById("disclaimer-text-element");
        <!-- const attachFileBtn = document.getElementById('attach-file-btn'); -->
        const fileInput = document.getElementById('file-input');
        const filePreviewContainer = document.getElementById('file-preview-container');
        const scanModelsBtn = document.getElementById('scan-ollama-models-btn');
        const addModelBtn = document.getElementById('add-custom-model-btn');
        const deleteModelBtn = document.getElementById('delete-selected-model-btn');
        const modelScanStatus = document.getElementById('model-scan-status');

        // --- State Variables ---
        let isGenerating = false;
        let currentSessionId = null;
        let settings = {};
        let sessions = {};
        let feedback = [];
        let abortController = null;
        let attachedFiles = [];

        // --- Initialization ---
        const initialize = () => {
            loadSettings();
            configureDOMPurify(); // Configure DOMPurify hooks
            configureMarked(); // Configure marked after settings are loaded
            loadFeedback();
            applyTheme();
            applyUISettings();
            loadSessions();
            if (!currentSessionId || !sessions[currentSessionId]) {
                createNewSession();
            }
            switchSession(currentSessionId);
            addEventListeners();
            resizeTextarea();
        };

        // --- NEW: Configure DOMPurify to handle links ---
        const configureDOMPurify = () => {
            // This hook ensures all links generated by Markdown will open in a new tab.
            DOMPurify.addHook('afterSanitizeElements', (node) => {
              if (node.tagName === 'A') {
                node.setAttribute('target', '_blank');
                node.setAttribute('rel', 'noopener noreferrer');
              }
            });
        };
        
        // --- MODIFIED: Configure marked to use highlight.js based on settings ---
        const configureMarked = () => {
            marked.setOptions({
                highlight: function(code, lang) {
                    if (settings.syntaxHighlighting) {
                        const language = hljs.getLanguage(lang) ? lang : 'plaintext';
                        return hljs.highlight(code, { language, ignoreIllegals: true }).value;
                    }
                    // Return plain, escaped code if highlighting is off
                    return code.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                },
                gfm: true,
                breaks: true
            });
        };

        const addEventListeners = () => {
            sidebarToggleBtn.addEventListener("click", toggleSidebar);
            newSessionBtn.addEventListener("click", createNewSession);
            typingForm.addEventListener("submit", (e) => handleSendMessage(e, {}));
            typingInput.addEventListener("input", resizeTextarea);
            typingInput.addEventListener("keydown", handleEnterKey);
            settingsBtn.addEventListener("click", openSettingsPanel);
            closeSettingsBtn.addEventListener("click", closeSettingsPanel);
            settingsOverlay.addEventListener("click", (e) => { if (e.target === settingsOverlay) closeSettingsPanel(); });
            saveSettingsBtn.addEventListener("click", saveAndApplySettings);
            stopGenerationBtn.addEventListener("click", stopGeneration);
            sessionSearchInput.addEventListener("input", renderSessionList);
            <!-- attachFileBtn.addEventListener('click', () => fileInput.click());  -->
            fileInput.addEventListener('change', handleFileSelect);
            
            addEventListenersForDragDrop();
            
            document.addEventListener('keydown', (e) => {
                if (e.key === "Escape" && body.classList.contains("settings-open")) {
                    closeSettingsPanel();
                }
            });

            document.addEventListener('contextmenu', (event) => {
                const target = event.target;
                const isInput = target.tagName === 'INPUT' || target.tagName === 'TEXTAREA' || target.isContentEditable || target.closest('pre');
                if (!isInput) {
                    event.preventDefault();
                }
            });

            settingsNavItems.forEach(item => {
                item.addEventListener("click", () => {
                    const section = item.dataset.section;
                    settingsNavItems.forEach(i => i.classList.remove("active"));
                    settingsContents.forEach(c => c.classList.remove("active"));
                    item.classList.add("active");
                    const contentEl = document.getElementById(`${section}-settings`);
                    contentEl.classList.add("active");
                    settingsTitle.textContent = item.querySelector("span:last-child").textContent;
                    
                    if (section === 'feedback') {
                        renderFeedbackTab();
                    }
                });
            });

            document.querySelectorAll(".theme-toggle-switch button").forEach(button => {
                button.addEventListener("click", () => {
                    settings.theme = button.dataset.theme;
                    applyTheme();
                    document.querySelectorAll(".theme-toggle-switch button").forEach(b => {
                        b.classList.toggle("active", b.dataset.theme === settings.theme);
                    });
                });
            });

            document.getElementById("temperature").addEventListener("input", e => {
                document.getElementById("temperature-value").textContent = e.target.value;
            });
            document.getElementById("show-disclaimer").addEventListener("change", e => {
                document.getElementById("custom-disclaimer-group").style.display = e.target.checked ? 'flex' : 'none';
            });
            document.getElementById("export-settings-btn").addEventListener("click", exportSettings);
            document.getElementById("import-settings-btn").addEventListener("click", importSettings);
            document.getElementById("export-all-chats-btn").addEventListener("click", exportAllChats);
            document.getElementById("import-all-chats-btn").addEventListener("click", importAllChats);
            document.getElementById("clear-all-chats-btn").addEventListener("click", clearAllChats);
            document.getElementById("font-size").addEventListener("change", e => {
                settings.fontSize = e.target.value;
                applyUISettings();
            });
            document.getElementById("compact-mode").addEventListener("change", e => {
                settings.compactMode = e.target.checked;
                applyUISettings();
            });
            
            scanModelsBtn.addEventListener('click', scanOllamaModels);
            addModelBtn.addEventListener('click', addCustomModel);
            deleteModelBtn.addEventListener('click', deleteSelectedModel);
        };
        
        // --- Model Management ---
        const populateModelDropdown = () => {
            const modelSelect = document.getElementById('model');
            const allModels = settings.customModels || [];

            modelSelect.innerHTML = ''; // Clear existing options
            
            if (allModels.length === 0) {
                 modelSelect.innerHTML = '<option value="">请先扫描或添加模型</option>';
            } else {
                allModels.forEach(modelName => {
                    const option = document.createElement('option');
                    option.value = modelName;
                    option.textContent = modelName;
                    modelSelect.appendChild(option);
                });
            }

            if (settings.model && allModels.includes(settings.model)) {
                modelSelect.value = settings.model;
            } else if (allModels.length > 0) {
                // If current model isn't valid, select the first one
                modelSelect.value = allModels[0];
                settings.model = allModels[0]; 
            } else {
                // No models available
                settings.model = "";
            }
        };

        const scanOllamaModels = async () => {
            const apiEndpoint = document.getElementById('api-endpoint').value.trim();
            if (!apiEndpoint) {
                showToast("请先设置API端点。", "error");
                return;
            }
            
            let tagsUrl;
            try {
                // Construct the '/api/tags' URL from the chat endpoint (e.g., http://host:port/api/chat -> http://host:port/api/tags)
                const url = new URL(apiEndpoint);
                tagsUrl = `${url.protocol}//${url.host}/api/tags`;
            } catch (e) {
                showToast("无效的API端点URL。", "error");
                return;
            }
            
            modelScanStatus.textContent = '正在扫描...';
            try {
                const response = await fetch(tagsUrl);
                if (!response.ok) {
                    throw new Error(`无法连接到Ollama: ${response.statusText}`);
                }
                const data = await response.json();
                
                if (!data.models || !Array.isArray(data.models)) {
                     throw new Error(`从Ollama返回的格式无效。`);
                }

                const modelNames = data.models.map(m => m.name);

                const currentModels = new Set(settings.customModels || []);
                modelNames.forEach(name => currentModels.add(name));
                settings.customModels = Array.from(currentModels).sort();

                saveSettings();
                populateModelDropdown();
                
                if (!settings.model && settings.customModels.length > 0) {
                    document.getElementById('model').value = settings.customModels[0];
                }

                modelScanStatus.textContent = `扫描完成！找到 ${modelNames.length} 个新模型。`;
                showToast("本地模型扫描成功！", "success");
            } catch (error) {
                console.error("Error scanning Ollama models:", error);
                modelScanStatus.textContent = '扫描失败。';
                showToast(`扫描失败: ${error.message}`, "error");
            }
        };

        const addCustomModel = () => {
            showPrompt("输入自定义模型名称:", "", (newModel) => {
                if (newModel && newModel.trim() !== "") {
                    const modelName = newModel.trim();
                    if (!settings.customModels) {
                        settings.customModels = [];
                    }
                    if (settings.customModels.includes(modelName)) {
                        showToast("该模型已存在。", "info");
                        return;
                    }
                    settings.customModels.push(modelName);
                    settings.customModels.sort();
                    saveSettings();
                    populateModelDropdown();
                    document.getElementById('model').value = modelName; // Select the new model
                    showToast(`模型 "${modelName}" 已添加。`, "success");
                }
            });
        };

        const deleteSelectedModel = () => {
            const modelSelect = document.getElementById('model');
            const modelToDelete = modelSelect.value;
            
            if (!modelToDelete || settings.customModels.length === 0) {
                showToast("没有可删除的模型。", "error");
                return;
            }

            showConfirm(`确认删除模型 "${modelToDelete}"？`, "此操作无法撤销。", () => {
                const index = settings.customModels.indexOf(modelToDelete);
                if (index > -1) {
                    settings.customModels.splice(index, 1);
                    saveSettings();
                    populateModelDropdown();
                    showToast(`模型 "${modelToDelete}" 已删除。`, "success");
                } else {
                    showToast("找不到要删除的模型。", "error");
                }
            });
        };

        // --- Feedback Management ---
        const loadFeedback = () => {
            feedback = JSON.parse(localStorage.getItem("ai-assistant-feedback")) || [];
        };

        const saveFeedback = () => {
            localStorage.setItem("ai-assistant-feedback", JSON.stringify(feedback));
        };

        const handleFeedback = (e) => {
            const button = e.currentTarget;
            const feedbackType = button.dataset.feedbackType;
            const messageIndex = parseInt(button.dataset.messageIndex, 10);
            const session = sessions[currentSessionId];
            const message = session?.history[messageIndex];

            if (message) {
                if (message.feedbackSubmitted) {
                    showToast("您已经反馈过了。", "info");
                    return;
                }

                feedback.push({
                    sessionId: currentSessionId,
                    messageIndex: messageIndex,
                    messageContent: message.content,
                    feedbackType: feedbackType,
                    timestamp: Date.now()
                });
                saveFeedback();

                message.feedbackSubmitted = feedbackType;
                saveSessions();

                showToast("感谢您的反馈！", "success");
                renderChat();
            }
        };

        const renderFeedbackTab = () => {
            const container = document.getElementById('feedback-settings');
            container.innerHTML = '';

            if (!feedback || feedback.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--subheading-color); padding: 2rem 0;">暂无反馈记录。</p>';
                return;
            }

            const feedbackList = document.createElement('ul');
            feedbackList.className = 'feedback-list';
            
            feedback.slice().reverse().forEach(item => {
                const li = document.createElement('li');
                li.className = 'feedback-item';
                const icon = item.feedbackType === 'like' ? 'thumb_up' : 'thumb_down';
                const color = item.feedbackType === 'like' ? 'var(--success-color)' : 'var(--error-color)';
                li.innerHTML = `
                    <div class="feedback-item-header">
                        <span class="material-symbols-rounded" style="color: ${color};">${icon}</span>
                        <span class="feedback-timestamp">${new Date(item.timestamp).toLocaleString()}</span>
                    </div>
                    <p class="feedback-message-content">${DOMPurify.sanitize(item.messageContent)}</p>
                `;
                feedbackList.appendChild(li);
            });

            const clearFeedbackBtn = document.createElement('button');
            clearFeedbackBtn.id = 'clear-all-feedback-btn';
            clearFeedbackBtn.textContent = '清除所有反馈';
            clearFeedbackBtn.className = 'glass-button error-button';
            clearFeedbackBtn.style.marginTop = '1.5rem';
            clearFeedbackBtn.style.width = '100%';

            clearFeedbackBtn.addEventListener('click', () => {
                showConfirm('确认清除所有反馈？', '此操作无法撤销。', () => {
                    feedback = [];
                    saveFeedback();
                    Object.values(sessions).forEach(session => {
                        session.history.forEach(message => {
                            if (message.feedbackSubmitted) {
                                delete message.feedbackSubmitted;
                            }
                        });
                    });
                    saveSessions();
                    renderFeedbackTab();
                    renderChat();
                    showToast('所有反馈已清除。', 'success');
                });
            });

            container.appendChild(feedbackList);
            container.appendChild(clearFeedbackBtn);
        };

        // --- Settings Management ---
        const loadSettings = () => {
            const savedSettings = JSON.parse(localStorage.getItem("ai-assistant-settings")) || {};
            settings = {
                theme: savedSettings.theme || "dark-mode",
                settingsWindowed: savedSettings.settingsWindowed === true,
                apiKey: savedSettings.apiKey !== undefined ? savedSettings.apiKey : "",
                apiEndpoint: savedSettings.apiEndpoint !== undefined ? savedSettings.apiEndpoint : "http://localhost:11434/api/chat",
                model: savedSettings.model || "",
                customModels: savedSettings.customModels || [],
                maxContextLength: savedSettings.maxContextLength || 20,
                systemPrompt: savedSettings.systemPrompt !== undefined ? savedSettings.systemPrompt : "You are a helpful assistant.",
                temperature: savedSettings.temperature || 0.7,
                displayMarkdown: savedSettings.displayMarkdown !== false,
                showDialogueInfo: savedSettings.showDialogueInfo === true,
                enableStreaming: savedSettings.enableStreaming !== false,
                showThinkingProcess: savedSettings.showThinkingProcess !== false,
                autoRunCode: savedSettings.autoRunCode === true,
                autoScroll: savedSettings.autoScroll !== false,
                // --- NEW: Add syntax highlighting setting with default to true ---
                syntaxHighlighting: savedSettings.syntaxHighlighting !== false,
                fontSize: savedSettings.fontSize || "medium",
                compactMode: savedSettings.compactMode === true,
                showTimestamps: savedSettings.showTimestamps === true,
                showAvatars: savedSettings.showAvatars === true,
                enableAnimations: savedSettings.enableAnimations !== false,
                welcomeTitle: savedSettings.welcomeTitle !== undefined ? savedSettings.welcomeTitle : "Hello, there",
                welcomeSubtitle: savedSettings.welcomeSubtitle !== undefined ? savedSettings.welcomeSubtitle : "How can I help you today?",
                welcomeSuggestions: savedSettings.welcomeSuggestions !== undefined ? savedSettings.welcomeSuggestions : "",
                showDisclaimer: savedSettings.showDisclaimer === true,
                disclaimerText: savedSettings.disclaimerText !== undefined ? savedSettings.disclaimerText : "FloeLM may display inaccurate info, so double-check its responses."
            };
        };

        const saveSettings = () => {
            localStorage.setItem("ai-assistant-settings", JSON.stringify(settings));
        };

        const applyTheme = () => {
            if (settings.theme === "system-mode") {
                const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
                body.classList.toggle("light-mode", !prefersDark);
            } else {
                body.classList.toggle("light-mode", settings.theme === "light-mode");
            }
            document.querySelectorAll(".theme-toggle-switch button").forEach(button => {
                button.classList.toggle("active", button.dataset.theme === settings.theme);
            });
        };

        const populateSettingsForm = () => {
            document.getElementById("api-key").value = settings.apiKey;
            document.getElementById("api-endpoint").value = settings.apiEndpoint;
            
            populateModelDropdown();

            document.getElementById("max-context-length").value = settings.maxContextLength;
            document.getElementById("system-prompt").value = settings.systemPrompt;
            document.getElementById("temperature").value = settings.temperature;
            document.getElementById("temperature-value").textContent = settings.temperature;
            document.getElementById("display-markdown").checked = settings.displayMarkdown;
            document.getElementById("settings-windowed-mode").checked = settings.settingsWindowed;
            document.getElementById("show-dialogue-info").checked = settings.showDialogueInfo;
            document.getElementById("enable-streaming").checked = settings.enableStreaming;
            document.getElementById("show-thinking-process").checked = settings.showThinkingProcess;
            document.getElementById("auto-run-code").checked = settings.autoRunCode;
            document.getElementById("auto-scroll").checked = settings.autoScroll;
            // --- NEW: Populate new syntax highlighting toggle ---
            document.getElementById("syntax-highlighting").checked = settings.syntaxHighlighting;
            document.getElementById("font-size").value = settings.fontSize;
            document.getElementById("compact-mode").checked = settings.compactMode;
            document.getElementById("show-timestamps").checked = settings.showTimestamps;
            document.getElementById("show-avatars").checked = settings.showAvatars;
            document.getElementById("enable-animations").checked = settings.enableAnimations;
            document.getElementById("welcome-title-input").value = settings.welcomeTitle;
            document.getElementById("welcome-subtitle-input").value = settings.welcomeSubtitle;
            document.getElementById("welcome-suggestions-input").value = settings.welcomeSuggestions;
            
            const showDisclaimerCheckbox = document.getElementById("show-disclaimer");
            const customDisclaimerGroup = document.getElementById("custom-disclaimer-group");
            const customDisclaimerInput = document.getElementById("custom-disclaimer-input");
            showDisclaimerCheckbox.checked = settings.showDisclaimer;
            customDisclaimerInput.value = settings.disclaimerText;
            customDisclaimerGroup.style.display = settings.showDisclaimer ? 'flex' : 'none';

            applyTheme();
        };

        const saveAndApplySettings = () => {
            settings.apiKey = document.getElementById("api-key").value.trim();
            settings.apiEndpoint = document.getElementById("api-endpoint").value.trim();
            settings.model = document.getElementById("model").value;
            settings.maxContextLength = Math.min(100, Math.max(1, parseInt(document.getElementById("max-context-length").value) || 20));
            settings.systemPrompt = document.getElementById("system-prompt").value;
            settings.temperature = parseFloat(document.getElementById("temperature").value);
            settings.displayMarkdown = document.getElementById("display-markdown").checked;
            settings.settingsWindowed = document.getElementById("settings-windowed-mode").checked;
            settings.showDialogueInfo = document.getElementById("show-dialogue-info").checked;
            settings.enableStreaming = document.getElementById("enable-streaming").checked;
            settings.showThinkingProcess = document.getElementById("show-thinking-process").checked;
            settings.autoRunCode = document.getElementById("auto-run-code").checked;
            settings.autoScroll = document.getElementById("auto-scroll").checked;
            // --- NEW: Save new syntax highlighting setting ---
            settings.syntaxHighlighting = document.getElementById("syntax-highlighting").checked;
            settings.fontSize = document.getElementById("font-size").value;
            settings.compactMode = document.getElementById("compact-mode").checked;
            settings.showTimestamps = document.getElementById("show-timestamps").checked;
            settings.showAvatars = document.getElementById("show-avatars").checked;
            settings.enableAnimations = document.getElementById("enable-animations").checked;
            settings.welcomeTitle = document.getElementById("welcome-title-input").value.trim();
            settings.welcomeSubtitle = document.getElementById("welcome-subtitle-input").value.trim();
            settings.welcomeSuggestions = document.getElementById("welcome-suggestions-input").value.trim();
            settings.showDisclaimer = document.getElementById("show-disclaimer").checked;
            settings.disclaimerText = document.getElementById("custom-disclaimer-input").value.trim();
            
            saveSettings();
            // --- NEW: Re-configure marked to apply syntax highlighting changes immediately ---
            configureMarked(); 
            applyUISettings();
            closeSettingsPanel();
            showToast("设置已保存！", "success");
        };

        const applyUISettings = () => {
            body.classList.remove("font-size-small", "font-size-medium", "font-size-large");
            body.classList.add(`font-size-${settings.fontSize}`);
            body.classList.toggle("compact-mode", settings.compactMode);
            body.classList.toggle("show-avatars", settings.showAvatars);
            body.classList.toggle("animations-disabled", !settings.enableAnimations);
            settingsOverlay.classList.toggle("windowed-view", settings.settingsWindowed);
            welcomeTitleEl.textContent = settings.welcomeTitle;
            welcomeSubtitleEl.textContent = settings.welcomeSubtitle;
            renderWelcomeSuggestions();
            body.classList.toggle("show-disclaimer", settings.showDisclaimer);
            disclaimerEl.textContent = settings.disclaimerText;
            renderChat(); // Re-render chat to apply potential markdown/highlighting changes
        };

        const renderWelcomeSuggestions = () => {
            welcomeSuggestionsEl.innerHTML = "";
            const suggestions = settings.welcomeSuggestions.split("\n").filter(s => s.trim() !== "");
            suggestions.forEach(s => {
                const [text, icon] = s.split("|");
                if(!text || text.trim() === "") return;
                const suggestionText = text.trim();
                const suggestionIcon = icon ? icon.trim() : "lightbulb";
                const li = document.createElement("li");
                li.className = "suggestion";
                li.innerHTML = `
                    <h4 class="text">${DOMPurify.sanitize(suggestionText)}</h4>
                    <span class="icon material-symbols-rounded">${DOMPurify.sanitize(suggestionIcon)}</span>
                `;
                li.addEventListener("click", handleSuggestionClick);
                welcomeSuggestionsEl.appendChild(li);
            });
        };

        const exportSettings = () => {
            const dataStr = JSON.stringify(settings, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = "floe-lm-settings.json";
            body.appendChild(a);
            a.click();
            body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast("设置已导出！", "success");
        };

        const importSettings = () => {
            const input = document.createElement("input");
            input.type = "file";
            input.accept = "application/json";
            input.onchange = e => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const importedSettings = JSON.parse(event.target.result);
                            const newSettings = { ...loadSettings(), ...importedSettings };
                            settings = newSettings;
                            saveSettings();
                            populateSettingsForm();
                            applyUISettings();
                            showToast("设置导入成功！", "success");
                        } catch (err) {
                            console.error("Error importing settings:", err);
                            showToast("导入设置失败: " + err.message, "error");
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        };

        // --- Session Management ---
        const loadSessions = () => {
            sessions = JSON.parse(localStorage.getItem("ai-assistant-sessions")) || {};
            currentSessionId = localStorage.getItem("ai-assistant-current-session");
        };

        const saveSessions = () => {
            localStorage.setItem("ai-assistant-sessions", JSON.stringify(sessions));
            localStorage.setItem("ai-assistant-current-session", currentSessionId);
        };

        const switchSession = (sessionId) => {
            if (isGenerating) {
                showToast("AI正在回复中，请稍后切换。", "info");
                return;
            }
            if (sessions[sessionId]) {
                currentSessionId = sessionId;
                renderSessionList();
                renderChat();
                saveSessions();
            }
        };

        const createNewSession = () => {
            if (isGenerating) {
                showToast("AI正在回复中，请稍后新建。", "info");
                return;
            }
            const newId = `session_${Date.now()}`;
            sessions[newId] = {
                name: `Chat ${Object.keys(sessions).length + 1}`,
                history: [],
                pinned: false,
                timestamp: Date.now()
            };
            switchSession(newId);
        };

        const deleteSession = (e, sessionId) => {
            e.stopPropagation();
            showConfirm("确认删除对话？", "此操作无法撤销。", () => {
                if (Object.keys(sessions).length <= 1) {
                    showToast("无法删除最后一个对话。", "error");
                    return;
                }
                delete sessions[sessionId];
                const remainingIds = Object.keys(sessions).sort((a, b) => sessions[b].timestamp - sessions[a].timestamp);
                if (currentSessionId === sessionId) {
                    switchSession(remainingIds[0]);
                } else {
                    renderSessionList();
                }
                saveSessions();
                showToast("对话已删除。", "success");
            });
        };

        const renameSession = (e, sessionId) => {
            e.stopPropagation();
            showPrompt("输入新的对话名称:", sessions[sessionId].name, (newName) => {
                if (newName && newName.trim() !== "") {
                    sessions[sessionId].name = newName.trim();
                    saveSessions();
                    renderSessionList();
                    showToast("对话名称已更新。", "success");
                }
            });
        };

        const pinSession = (e, sessionId) => {
            e.stopPropagation();
            sessions[sessionId].pinned = !sessions[sessionId].pinned;
            saveSessions();
            renderSessionList();
            showToast(sessions[sessionId].pinned ? "对话已置顶。" : "对话已取消置顶。", "info");
        };
        
        const clearAllChats = () => {
            showConfirm("确认清除所有对话？", "此操作无法撤销，所有对话都将被删除。", () => {
                sessions = {};
                currentSessionId = null;
                saveSessions();
                createNewSession();
                showToast("所有对话已清除。", "success");
            });
        };

        const exportAllChats = () => {
            if (Object.keys(sessions).length === 0) {
                showToast("没有可导出的对话。", "error");
                return;
            }
            const dataStr = JSON.stringify(sessions, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.download = `floe-lm-chats-${new Date().toISOString().slice(0, 10)}.json`;
            a.href = url;
            body.appendChild(a);
            a.click();
            body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast("所有对话已导出！", "success");
        };

        const importAllChats = () => {
            const input = document.createElement("input");
            input.type = "file";
            input.accept = "application/json";
            input.onchange = e => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const importedSessions = JSON.parse(event.target.result);
                            sessions = { ...sessions, ...importedSessions };
                            saveSessions();
                            const latestSessionId = Object.keys(sessions).sort((a, b) => sessions[b].timestamp - sessions[a].timestamp)[0];
                            renderSessionList();
                            if(latestSessionId) switchSession(latestSessionId);
                            showToast("对话导入成功！", "success");
                        } catch (err) {
                            console.error("Error importing chats:", err);
                            showToast("导入对话失败: " + err.message, "error");
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        };

        // --- UI Rendering ---
        const renderSessionList = () => {
            sessionList.innerHTML = "";
            const searchTerm = sessionSearchInput.value.toLowerCase();
            
            const filtered = Object.entries(sessions).filter(([id, session]) => {
                const nameMatch = session.name.toLowerCase().includes(searchTerm);
                const historyMatch = session.history.some(msg => msg.content.toLowerCase().includes(searchTerm));
                return nameMatch || historyMatch;
            });

            const sorted = filtered.sort((a, b) => {
                const sessionA = a[1];
                const sessionB = b[1];
                if (sessionA.pinned !== sessionB.pinned) return sessionA.pinned ? -1 : 1;
                const lastMsgTimeA = sessionA.history.length > 0 ? sessionA.history[sessionA.history.length - 1].timestamp : sessionA.timestamp;
                const lastMsgTimeB = sessionB.history.length > 0 ? sessionB.history[sessionB.history.length - 1].timestamp : sessionB.timestamp;
                return lastMsgTimeB - lastMsgTimeA;
            });

            if (sorted.length === 0) {
                sessionList.innerHTML = `<li style="text-align: center; color: var(--subheading-color); padding: 1rem; user-select: none; border: none;">${searchTerm ? '无匹配对话' : '暂无对话'}</li>`;
                return;
            }

            for (const [id, session] of sorted) {
                const li = document.createElement("li");
                li.dataset.sessionId = id;
                if (id === currentSessionId) li.classList.add("active");
                if (session.pinned) li.classList.add("pinned-session");
                
                const pinIconClass = session.pinned ? 'pinned' : ''; 
                const pinIconTitle = session.pinned ? '置顶' : '取消置顶';

                li.innerHTML = `
                    <span class="session-name">${DOMPurify.sanitize(session.name)}</span>
                    <div class="session-actions">
                        <span class="material-symbols-rounded pin-session ${pinIconClass}" title="${pinIconTitle}">push_pin</span>
                        <span class="material-symbols-rounded rename-session" title="重命名对话">edit</span>
                        <span class="material-symbols-rounded delete-session" title="删除对话">delete</span>
                    </div>
                `;
                li.addEventListener("click", () => switchSession(id));
                li.querySelector(".rename-session").addEventListener("click", (e) => renameSession(e, id));
                li.querySelector(".delete-session").addEventListener("click", (e) => deleteSession(e, id));
                li.querySelector(".pin-session").addEventListener("click", (e) => pinSession(e, id));
                sessionList.appendChild(li);
            }
        };

        const renderChat = () => {
            const session = sessions[currentSessionId];
            if (session) {
                chatContainer.innerHTML = "";
                session.history.forEach((message, index) => {
                    const messageEl = createMessageElement(message, index);
                    chatContainer.appendChild(messageEl);
                });
                body.classList.toggle("hide-header", session.history.length > 0);
                if (settings.autoScroll) {
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                }
            } else {
                chatContainer.innerHTML = "";
                body.classList.remove("hide-header");
            }
        };
        
        const parseThinkContent = (rawContent) => {
            const thinkRegex = /<think>([\s\S]*?)<\/think>/;
            const match = rawContent.match(thinkRegex);
            if (match) {
                const thinking = match[1].trim();
                const content = rawContent.replace(thinkRegex, "").trim();
                return { thinking, content };
            }
            return { thinking: null, content: rawContent };
        };

        const createMessageElement = (message, index) => {
            const { role, content, thinking, timestamp, feedbackSubmitted, dialogueInfo } = message;
            const wrapper = document.createElement("div");
            wrapper.className = `message ${role === 'user' ? 'outgoing' : 'incoming'}`;
            const avatarIcon = role === 'user' ? 'person' : 'smart_toy';
            
            const textDiv = document.createElement('div');
            textDiv.className = 'text';
            if (settings.displayMarkdown && role === 'assistant') {
                textDiv.innerHTML = DOMPurify.sanitize(marked.parse(content || ''));
                textDiv.classList.add('markdown-body');
            } else {
                const sanitizedContent = content.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                textDiv.innerHTML = sanitizedContent.replace(/\n/g, '<br>');
            }

            let thinkingHTML = '';
            if (role === 'assistant' && thinking && settings.showThinkingProcess) {
                const thinkingContentHTML = DOMPurify.sanitize(marked.parse(thinking));
                thinkingHTML = `
                    <div class="thinking-process">
                        <div class="thinking-content-wrapper collapsed">
                            <div class="thinking-header">
                                <span class="material-symbols-rounded">expand_more</span>
                                思考过程
                            </div>
                            <div class="thinking-content markdown-body">${thinkingContentHTML}</div>
                        </div>
                    </div>
                `;
            }

            const timestampHTML = settings.showTimestamps && timestamp ?
                `<span class="timestamp" style="font-size: 0.75rem; color: var(--placeholder-color); margin-top: 0.25rem; display: block;">${new Date(timestamp).toLocaleString()}</span>` : '';

            const feedbackButtonsHTML = role === 'assistant' ? `
                <button class="icon thumb-up ${feedbackSubmitted === 'like' ? 'active' : ''}" title="喜欢" data-feedback-type="like" data-message-index="${index}" ${feedbackSubmitted ? 'disabled' : ''}><span class="material-symbols-rounded">thumb_up</span></button>
                <button class="icon thumb-down ${feedbackSubmitted === 'dislike' ? 'active' : ''}" title="不喜欢" data-feedback-type="dislike" data-message-index="${index}" ${feedbackSubmitted ? 'disabled' : ''}><span class="material-symbols-rounded">thumb_down</span></button>
            ` : '';

            let dialogueInfoHTML = '';
            if (role === 'assistant' && dialogueInfo && settings.showDialogueInfo) {
                dialogueInfoHTML = `
                    <div class="dialogue-info">
                        <span><span class="material-symbols-rounded" style="font-size: inherit;">bolt</span> ${dialogueInfo.tokensPerSecond} token/s</span>
                        <span><span class="material-symbols-rounded" style="font-size: inherit;">timer</span> ${dialogueInfo.timeToFirstToken}s (首个)</span>
                        <span>${dialogueInfo.totalTime}s (总计)</span>
                        <span>${dialogueInfo.model}</span>
                    </div>
                `;
            }

            wrapper.innerHTML = `
                <div class="avatar"><span class="material-symbols-rounded">${avatarIcon}</span></div>
                <div class="message-content">
                    ${thinkingHTML}
                    ${textDiv.outerHTML}
                    ${timestampHTML}
                    <div class="message-footer">
                         ${dialogueInfoHTML}
                        <div class="action-btns">
                            ${role === 'user' ? `<button class="icon edit-prompt" title="编辑消息"><span class="material-symbols-rounded">edit</span></button>` : ''}
                            <button class="icon copy" title="复制"><span class="material-symbols-rounded">content_copy</span></button>
                            ${role === 'assistant' ? `<button class="icon regenerate" title="重新生成"><span class="material-symbols-rounded">refresh</span></button>` : ''}
                            ${feedbackButtonsHTML}
                        </div>
                    </div>
                </div>
            `;

            wrapper.querySelectorAll('pre').forEach(pre => {
                const copyBtn = document.createElement('button');
                copyBtn.className = 'copy-code-btn';
                copyBtn.innerHTML = `<span class="material-symbols-rounded">content_copy</span><span>Copy</span>`;
                copyBtn.title = 'Copy code';

                copyBtn.addEventListener('click', () => {
                    const codeToCopy = pre.querySelector('code').textContent;
                    navigator.clipboard.writeText(codeToCopy).then(() => {
                        copyBtn.querySelector('span:last-child').textContent = 'Copied!';
                        setTimeout(() => {
                           copyBtn.querySelector('span:last-child').textContent = 'Copy';
                        }, 2000);
                    }).catch(err => {
                        showToast('Failed to copy code.', 'error');
                        console.error('Copy failed', err);
                    });
                });
                pre.appendChild(copyBtn);
            });

            wrapper.querySelector(".copy").addEventListener("click", () => copyToClipboard(content));
            
            if (role === 'assistant') {
                wrapper.querySelector(".regenerate")?.addEventListener("click", () => regenerateResponse(index));
                wrapper.querySelectorAll('.thumb-up, .thumb-down').forEach(btn => {
                    btn.addEventListener('click', handleFeedback);
                });
                const thinkingHeader = wrapper.querySelector('.thinking-header');
                if (thinkingHeader) {
                    thinkingHeader.addEventListener('click', (e) => {
                        e.currentTarget.parentElement.classList.toggle('collapsed');
                    });
                }
            }
            
            if (role === 'user') {
                wrapper.querySelector(".edit-prompt")?.addEventListener("click", () => editMessage(index));
            }

            return wrapper;
        };
        
        // --- File Handling ---
        const addEventListenersForDragDrop = () => {
            let dragCounter = 0;

            mainContent.addEventListener('dragenter', (e) => {
                e.preventDefault();
                e.stopPropagation();
                dragCounter++;
                mainContent.classList.add('drag-over');
            });

            mainContent.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.stopPropagation();
            });

            mainContent.addEventListener('dragleave', (e) => {
                e.preventDefault();
                e.stopPropagation();
                dragCounter--;
                if (dragCounter === 0) {
                    mainContent.classList.remove('drag-over');
                }
            });

            mainContent.addEventListener('drop', (e) => {
                e.preventDefault();
                e.stopPropagation();
                dragCounter = 0;
                mainContent.classList.remove('drag-over');
                
                const files = e.dataTransfer.files;
                if (files && files.length > 0) {
                    handleFiles(files);
                }
            });
        };

        const handleFileSelect = (event) => {
            const files = event.target.files;
            if (files && files.length > 0) {
                handleFiles(files);
            }
            fileInput.value = '';
        };
        
        const handleFiles = (files) => {
            for (const file of files) {
                attachedFiles.push(file);
            }
            renderFilePreview();
        };

        const renderFilePreview = () => {
            filePreviewContainer.innerHTML = '';
            body.classList.toggle('has-files', attachedFiles.length > 0);
            if (attachedFiles.length > 0) {
                attachedFiles.forEach((file, index) => {
                    const chip = document.createElement('div');
                    chip.className = 'file-chip';
                    chip.innerHTML = `
                        <span>${DOMPurify.sanitize(file.name)}</span>
                        <button class="remove-file-btn" data-index="${index}" title="Remove file"><span class="material-symbols-rounded">close</span></button>
                    `;
                    chip.querySelector('.remove-file-btn').addEventListener('click', removeAttachedFile);
                    filePreviewContainer.appendChild(chip);
                });
            }
        };
        
        const removeAttachedFile = (event) => {
            const index = parseInt(event.currentTarget.dataset.index, 10);
            if (!isNaN(index)) {
                attachedFiles.splice(index, 1);
                renderFilePreview();
            }
        };

        const clearAttachedFiles = () => {
            attachedFiles = [];
            renderFilePreview();
        };

        const processFile = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    let fileContentHTML = '';
                    if (file.type.startsWith('image/')) {
                        fileContentHTML = `<br><img src="${e.target.result}" alt="${file.name}" class="attached-image">`;
                    } else if (file.type.startsWith('text/')) {
                        const textContent = e.target.result;
                        const sanitizedText = textContent.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                        fileContentHTML = `\n\n--- ${file.name} ---\n<div class="attached-file-content">${sanitizedText}</div>`;
                    } else {
                        fileContentHTML = `\n\n[File Attached: ${file.name}]`;
                    }
                    resolve(fileContentHTML);
                };
                reader.onerror = (error) => reject(error);

                if (file.type.startsWith('image/')) {
                    reader.readAsDataURL(file);
                } else {
                    reader.readAsText(file);
                }
            });
        };

        // --- Chat Logic ---
        const handleSendMessage = async (event, options = {}) => {
            event?.preventDefault(); 

            if (!settings.model) {
                showToast("请在设置中选择或添加一个模型。", "error");
                return;
            }

            const { overridePrompt, isRegeneration = false } = options;
            let userPrompt = (overridePrompt || typingInput.value).trim();

            if ((!userPrompt && attachedFiles.length === 0) || isGenerating) return;

            const requestSessionId = currentSessionId;

            isGenerating = true;
            abortController = new AbortController();
            toggleStopButton(true);
            
            const startTime = Date.now();
            let firstChunkTime = null;
            const onFirstChunk = () => {
                if (!firstChunkTime) {
                    firstChunkTime = Date.now();
                }
            };

            try {
                if (!isRegeneration && attachedFiles.length > 0) {
                    const fileProcessingPromises = attachedFiles.map(file => processFile(file));
                    const fileHTMLs = await Promise.all(fileProcessingPromises);
                    userPrompt += fileHTMLs.join('');
                }

                typingInput.value = "";
                resizeTextarea();
                clearAttachedFiles();

                if (!isRegeneration) {
                    sessions[requestSessionId].history.push({ role: "user", content: userPrompt, timestamp: Date.now() });
                    if (sessions[requestSessionId].history.length === 1 && sessions[requestSessionId].name.startsWith("Chat ")) {
                        const plainTextPrompt = userPrompt.replace(/<[^>]*>?/gm, '');
                        sessions[requestSessionId].name = plainTextPrompt.substring(0, 30) || "Chat";
                        renderSessionList();
                    }
                }
                
                saveSessions();
                renderChat();

                const tempAssistantMsgEl = createMessageElement({role: "assistant", content: '<div class="loading-indicator"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div>'});
                chatContainer.appendChild(tempAssistantMsgEl);
                if (settings.autoScroll) {
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                }

                const rawResponse = await getAIResponse(requestSessionId, tempAssistantMsgEl, onFirstChunk);
                const { thinking, content } = parseThinkContent(rawResponse);
                
                const endTime = Date.now();
                const totalTime = (endTime - startTime) / 1000;
                const timeToFirstToken = firstChunkTime ? ((firstChunkTime - startTime) / 1000).toFixed(2) : (totalTime / 3).toFixed(2);
                const simulatedTokenCount = (rawResponse.length / 4);
                const tokensPerSecond = totalTime > 0 ? (simulatedTokenCount / totalTime).toFixed(1) : "N/A";

                const dialogueInfo = {
                    tokensPerSecond: tokensPerSecond,
                    timeToFirstToken: timeToFirstToken,
                    totalTime: totalTime.toFixed(2),
                    model: settings.model
                };

                sessions[requestSessionId].history.push({ 
                    role: "assistant", 
                    content, 
                    thinking, 
                    timestamp: Date.now(),
                    dialogueInfo: dialogueInfo
                });

            } catch (error) {
                if (error.name === 'AbortError') {
                    const tempAssistantMsgEl = chatContainer.querySelector('.message:last-child .text');
                    const { thinking, content } = parseThinkContent(tempAssistantMsgEl?.innerHTML || "");
                    
                    const dialogueInfo = {
                        tokensPerSecond: "N/A",
                        timeToFirstToken: "N/A",
                        totalTime: "Stopped",
                        model: settings.model
                    };

                    sessions[requestSessionId].history.push({ 
                        role: "assistant", 
                        content: content || "已停止生成。", 
                        thinking, 
                        timestamp: Date.now(),
                        dialogueInfo: dialogueInfo
                    });
                    showToast("生成已停止。", "info");
                } else {
                    console.error("Error sending message:", error);
                    sessions[requestSessionId].history.push({ role: "assistant", content: `抱歉，出错了: ${error.message}`, timestamp: Date.now() });
                    showToast(`Error: ${error.message}`, "error");
                }
            } finally {
                isGenerating = false;
                toggleStopButton(false);
                saveSessions();
                renderChat(); 
            }
        };
        
        const getAIResponse = async (requestSessionId, messageElement, onFirstChunk) => {
            const textElement = messageElement.querySelector('.text');
            let fullResponse = "";

            if (!settings.apiEndpoint) throw new Error("API端点未设置。请在设置中添加。");
            if (!settings.model) throw new Error("模型未选择。请在设置中选择一个模型。");

            const history = (sessions[requestSessionId]?.history || [])
                .filter(msg => msg.role !== 'error')
                .slice(-settings.maxContextLength);
            
            const messages = [
                { role: "system", content: settings.systemPrompt },
                ...history.map(msg => ({ role: msg.role, content: msg.content.replace(/<[^>]*>?/gm, '') })),
            ];

            const body = {
                model: settings.model,
                messages: messages,
                stream: settings.enableStreaming,
                options: {
                    temperature: settings.temperature
                }
            };
            
            const headers = { "Content-Type": "application/json" };
            if (settings.apiKey) {
                headers.Authorization = `Bearer ${settings.apiKey}`;
            }

            const response = await fetch(settings.apiEndpoint, {
                method: "POST",
                headers: headers,
                body: JSON.stringify(body),
                signal: abortController.signal,
            });

            if (!response.ok) {
                const errorText = await response.text();
                try {
                    const errorData = JSON.parse(errorText);
                    throw new Error(errorData.error?.message || errorData.error || `API 错误: ${response.status} ${response.statusText}`);
                } catch (e) {
                     throw new Error(errorText || `API 错误: ${response.status} ${response.statusText}`);
                }
            }

            if (settings.enableStreaming && response.body) {
                let thinkingProcessRendered = false;
                textElement.innerHTML = "";
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop(); 

                    for (const line of lines) {
                        if (currentSessionId !== requestSessionId) {
                            try {
                                const dataStr = line.replace(/^data: /, '').trim();
                                if (dataStr.length > 0 && dataStr !== '[DONE]') {
                                     const data = JSON.parse(dataStr);
                                     const chunk = data.choices ? (data.choices[0]?.delta?.content || "") : (data.message?.content || "");
                                     fullResponse += chunk;
                                }
                            } catch (e) { /* ignore parsing errors */ }
                            continue;
                        }

                        if (line.trim().length === 0) continue;
                        const dataStr = line.replace(/^data: /, '').trim();
                        if (dataStr === '[DONE]') {
                            return fullResponse;
                        }
                        try {
                            const data = JSON.parse(dataStr);
                            const chunk = data.choices ? (data.choices[0]?.delta?.content || "") : (data.message?.content || "");
                            if (chunk) {
                                onFirstChunk();
                                fullResponse += chunk;
                                
                                const { thinking, content } = parseThinkContent(fullResponse);

                                if (thinking && !thinkingProcessRendered && settings.showThinkingProcess) {
                                    thinkingProcessRendered = true;
                                    const thinkingHTML = `
                                        <div class="thinking-process">
                                            <div class="thinking-content-wrapper collapsed">
                                                <div class="thinking-header">
                                                    <span class="material-symbols-rounded">expand_more</span>
                                                    思考过程
                                                </div>
                                                <div class="thinking-content markdown-body"></div>
                                            </div>
                                        </div>`;
                                    messageElement.querySelector('.message-content').insertAdjacentHTML('afterbegin', thinkingHTML);
                                    messageElement.querySelector('.thinking-header').addEventListener('click', (e) => {
                                        e.currentTarget.parentElement.classList.toggle('collapsed');
                                    });
                                }

                                if (thinkingProcessRendered) {
                                    const thinkingContentEl = messageElement.querySelector('.thinking-content');
                                    if(thinkingContentEl) thinkingContentEl.innerHTML = DOMPurify.sanitize(marked.parse(thinking || ' '));
                                }
                                
                                if (settings.displayMarkdown) {
                                    textElement.innerHTML = DOMPurify.sanitize(marked.parse(content || ' '));
                                    textElement.querySelectorAll('pre:not(:has(.copy-code-btn))').forEach(pre => {
                                        const copyBtn = document.createElement('button');
                                        copyBtn.className = 'copy-code-btn';
                                        copyBtn.innerHTML = `<span class="material-symbols-rounded">content_copy</span><span>Copy</span>`;
                                        copyBtn.addEventListener('click', () => {
                                            navigator.clipboard.writeText(pre.querySelector('code').textContent);
                                            copyBtn.querySelector('span:last-child').textContent = 'Copied!';
                                            setTimeout(() => copyBtn.querySelector('span:last-child').textContent = 'Copy', 2000);
                                        });
                                        pre.appendChild(copyBtn);
                                    });
                                } else {
                                    textElement.textContent = content;
                                }
                                if (settings.autoScroll) {
                                    chatContainer.scrollTop = chatContainer.scrollHeight;
                                }
                            }
                        } catch (e) {
                            console.error("Error parsing stream data:", e, "Data string:", dataStr);
                        }
                    }
                }
                return fullResponse;
            } else {
                const data = await response.json();
                fullResponse = data.choices ? (data.choices[0]?.message?.content.trim() || "") : (data.message?.content.trim() || "抱歉，我无法获取响应。");
                onFirstChunk();
                return fullResponse;
            }
        };

        const regenerateResponse = (messageIndex) => {
            const userMessageIndex = messageIndex - 1;
            if (userMessageIndex < 0 || isGenerating) return;

            const userPrompt = sessions[currentSessionId].history[userMessageIndex].content;
            sessions[currentSessionId].history.splice(userMessageIndex + 1);
            handleSendMessage(null, { overridePrompt: userPrompt, isRegeneration: true });
        };

        const editMessage = (index) => {
            if (isGenerating) return;
            const originalContent = sessions[currentSessionId].history[index].content;
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = originalContent;
            const plainTextContent = tempDiv.textContent || tempDiv.innerText || "";

            showPrompt("编辑您的消息:", plainTextContent, (newContent) => {
                if (newContent && newContent.trim() !== "" && newContent.trim() !== plainTextContent.trim()) {
                    sessions[currentSessionId].history.splice(index);
                    handleSendMessage(null, { overridePrompt: newContent.trim() });
                }
            });
        };

        // --- UI Helpers ---
        const toggleSidebar = () => {
            body.classList.toggle("sidebar-closed");
            body.classList.toggle("sidebar-open");
        };

        const openSettingsPanel = () => {
            populateSettingsForm();
            body.classList.add("settings-open");
            settingsOverlay.style.display = 'flex';
            const activeNavItem = document.querySelector(".settings-nav-item.active") || document.querySelector(".settings-nav-item");
            if (activeNavItem) activeNavItem.click();
        };

        const closeSettingsPanel = () => {
            body.classList.remove("settings-open");
            settingsOverlay.style.display = 'none';
        };

        const handleSuggestionClick = (e) => {
            const prompt = e.currentTarget.querySelector(".text").textContent;
            typingInput.value = prompt;
            handleSendMessage(new Event('submit'), {}); 
        };

        const handleEnterKey = (e) => {
            if (e.key === "Enter" && !e.shiftKey) {
                e.preventDefault();
                typingForm.dispatchEvent(new Event("submit", { cancelable: true, bubbles: true }));
            }
        };

        const resizeTextarea = () => {
            typingInput.style.height = "auto";
            typingInput.style.height = `${typingInput.scrollHeight}px`;
        };

        const copyToClipboard = (text) => {
            const tempDiv = document.createElement("div");
            tempDiv.innerHTML = text;
            const plainText = tempDiv.textContent || tempDiv.innerText || "";

            navigator.clipboard.writeText(plainText)
                .then(() => showToast("已复制到剪贴板！", "success"))
                .catch(err => {
                    console.error("Failed to copy: ", err);
                    showToast("复制失败！", "error");
                });
        };

        const stopGeneration = () => {
            if (abortController) {
                abortController.abort();
            }
        };

        const toggleStopButton = (showStop) => {
            const sendBtn = document.getElementById("send-message-button");
            const stopBtn = document.getElementById("stop-generation-btn");
            if (showStop) {
                sendBtn.style.display = 'none';
                stopBtn.style.display = 'flex';
            } else {
                sendBtn.style.display = 'flex';
                stopBtn.style.display = 'none';
            }
        };

        // --- Modals and Toasts ---
        const createModal = (type, title, message, callback = null, defaultValue = "") => {
            const modalPlaceholder = document.getElementById("custom-modal-placeholder");
            const existingModal = document.getElementById("custom-modal-overlay");
            if (existingModal) existingModal.remove();

            const overlay = document.createElement("div");
            overlay.id = "custom-modal-overlay";
            const content = document.createElement("div");
            content.classList.add("modal-content");
            content.innerHTML = `
                <h4>${DOMPurify.sanitize(title)}</h4>
                <p>${DOMPurify.sanitize(message)}</p>
                ${type === 'prompt' ? `<textarea class="modal-input glass-input" rows="4"></textarea>` : ''}
                <div class="modal-buttons">
                    ${type !== 'alert' ? '<button class="modal-cancel-btn">取消</button>' : ''}
                    <button class="modal-confirm-btn">${type === 'alert' ? '确定' : '确认'}</button>
                </div>
            `;
            
            const input = content.querySelector(".modal-input");
            if (input) {
                input.value = defaultValue;
            }

            overlay.appendChild(content);
            modalPlaceholder.appendChild(overlay);

            setTimeout(() => overlay.classList.add("show"), 10);

            const confirmBtn = content.querySelector(".modal-confirm-btn");
            const cancelBtn = content.querySelector(".modal-cancel-btn");
            
            let handleEsc;

            const closeModal = () => {
                overlay.classList.remove("show");
                overlay.addEventListener("transitionend", () => overlay.remove(), { once: true });
                document.removeEventListener('keydown', handleEsc);
            };

            handleEsc = (e) => {
                if (e.key === "Escape") closeModal();
            };
            document.addEventListener('keydown', handleEsc);

            confirmBtn.addEventListener("click", () => {
                if (callback) {
                    type === 'prompt' ? callback(input.value) : callback();
                }
                closeModal();
            });

            if (cancelBtn) cancelBtn.addEventListener("click", closeModal);
            overlay.addEventListener("click", e => {
                if (e.target === overlay) closeModal();
            });
            if (input) {
                input.focus();
                input.select();
                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        confirmBtn.click();
                    }
                });
            }
        };

        const showToast = (message, type = "info", duration = 3000) => {
            const container = document.getElementById("toast-container") || (() => {
                const c = document.createElement("div");
                c.id = "toast-container";
                body.appendChild(c);
                return c;
            })();
            const toast = document.createElement("div");
            toast.classList.add("toast-message", type);
            const icon = { info: "info", success: "check_circle", error: "error" }[type];
            toast.innerHTML = `<span class="material-symbols-rounded">${icon}</span> ${DOMPurify.sanitize(message)}`;
            container.appendChild(toast);
            setTimeout(() => toast.classList.add("show"), 10);
            setTimeout(() => {
                toast.classList.remove("show");
                toast.addEventListener("transitionend", () => toast.remove(), { once: true });
            }, duration);
        };

        const showConfirm = (title, message, callback) => {
            createModal('confirm', title, message, callback);
        };

        const showPrompt = (title, defaultValue, callback) => {
            createModal('prompt', title, "", callback, defaultValue);
        };

        // --- Start the App ---
        initialize();

    });</script></body></html>
